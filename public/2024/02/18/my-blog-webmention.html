<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link rel="stylesheet" href="/assets/css/style.css" />
  <script src="https://kit.fontawesome.com/f4170b83c1.js" crossorigin="anonymous"></script>

  <link rel="me" href="https://github.com/gr36" />
  <link rel="me" href="https://instagram.com/_greg_morris" />
  <link rel="me" href="https://gregmorris.co.uk">
  <meta property="og:description" content="
This week I have been building parts of my blog, to learn and to get it to a point that I am happy with. A large part of this was webmentions, and thanks to a few excellent guides I got 90% of the the way their. With only a few design things to think through I read more posts on webmentions and realised the way I was doing it was the best solution for privacy and so here we are with a reduced version." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/2024/02/18/my-blog-webmention.html" />
<meta name=”twitter:card” content=”summary” /> 



<meta property="og:image" content="https://greg-morris.micro.blog/uploads/2024/6c7d3fa5a0.jpg" />









<meta property="article:published_time" content="2024-02-18T08:22:00&#43;00:00"/>



<meta property="article:modified_time" content="2024-04-12T10:07:06&#43;00:00"/>










  <title>Greg Morris
		- My Blog Webmention Counts</title>
  
  <link rel="alternate" href="http://localhost:1313/feed.xml" type="application/rss+xml" title="Greg Morris">
  <link rel="alternate" href="http://localhost:1313/feed.json" type="application/json" title="Greg Morris">











<link rel="EditURI" type="application/rsd+xml" href="http://localhost:1313/rsd.xml">
<link rel="authorization_endpoint" href="https://micro.blog/indieauth/auth">
<link rel="token_endpoint" href="https://micro.blog/indieauth/token">
<link rel="subscribe" href="https://micro.blog/users/follow">
<link rel="webmention" href="https://micro.blog/webmention">
<link rel="micropub" href="https://micro.blog/micropub">
<link rel="microsub" href="https://micro.blog/microsub">

<link rel="stylesheet" href="/custom.css?1735590388">


  <link rel="stylesheet" href="/css/bookgoals.css?1736075796">



  
<script type="module">
  const base64Decode = (text) => decodeURIComponent(atob(text));

  document.addEventListener('click', e => {
    const link = e.target.closest('a.reply-by-email');

    if (link) {
      e.preventDefault();
      window.location = base64Decode(link.dataset.meta.match(/.{2}/g).map(hex => String.fromCharCode(parseInt(hex, 16) ^ 0x24)).join(''));
    }
  });
  </script>


</head>

<body>
<div class="header flow">
    <svg role="img" aria-label="Greg Morris" viewBox="0 0 420.84 64.11" xmlns="http://www.w3.org/2000/svg">
    <defs>
    <style>.cls-1 {
            fill: #231f20;
        }</style>
    </defs>
    <g data-name="Layer 1">
    <path class="cls-1" d="M0,27.45v-.14C0,13.01,11.14,1.3,26.37,1.3c8.99,0,14.59,2.44,19.76,6.9l-6.97,8.41c-3.81-3.23-7.4-5.1-13.15-5.1-8.05,0-14.44,7.12-14.44,15.67v.14c0,9.2,6.33,15.95,15.24,15.95,4.1,0,7.62-1.01,10.42-3.02v-7.19h-11.14v-9.56h21.85v21.85c-5.17,4.39-12.29,7.98-21.49,7.98C10.78,53.33,0,42.4,0,27.45Z"/>
    <path class="cls-1" d="M57.45,13.94h10.93v7.76c2.23-5.25,5.75-8.77,12.29-8.48v11.43h-.58c-7.26,0-11.71,4.31-11.71,13.58v14.23h-10.93V13.94Z"/>
    <path class="cls-1" d="M84.56,33.42v-.14c0-11,7.83-20.05,19.04-20.05,12.86,0,18.76,9.99,18.76,20.91,0,.86-.07,1.8-.15,2.87h-26.8c1.08,4.96,4.53,7.55,9.41,7.55,3.67,0,6.25-1.15,9.34-3.95l6.25,5.53c-3.66,4.53-8.77,7.19-15.74,7.19-11.57,0-20.12-8.12-20.12-19.91ZM111.72,30.19c-.65-4.89-3.52-8.19-8.12-8.19s-7.48,3.23-8.34,8.19h16.46Z"/>
    <path class="cls-1" d="M130.72,60.08l3.74-8.19c4.03,2.23,7.84,3.52,13.01,3.52,7.47,0,11-3.59,11-10.49v-1.87c-3.23,3.95-6.76,6.25-12.58,6.25-8.99,0-17.1-6.47-17.1-17.96v-.14c0-11.5,8.26-17.97,17.1-17.97,5.96,0,9.49,2.52,12.43,5.75v-5.03h10.92v29.83c0,6.83-1.65,11.93-4.89,15.16-3.66,3.66-9.13,5.17-16.6,5.17-6.32,0-12.15-1.44-17.03-4.02ZM158.46,31.34v-.14c0-5.25-4.02-8.91-9.42-8.91s-9.34,3.66-9.34,8.91v.14c0,5.39,3.95,8.91,9.34,8.91s9.42-3.66,9.42-8.91Z"/>
    <path class="cls-1" d="M201.76,2.16h11.93l13.22,21.27,13.22-21.27h11.93v50.31h-11V19.62l-14.16,21.49h-.29l-14.01-21.27v32.63h-10.85V2.16Z"/>
    <path class="cls-1" d="m261.16 33.42v-0.14c0-11.07 8.91-20.05 20.91-20.05s20.77 8.77 20.77 19.91v0.14c0 11.07-8.91 20.05-20.91 20.05s-20.77-8.77-20.77-19.91zm30.9 0v-0.14c0-5.68-4.1-10.64-10.13-10.64s-9.99 4.74-9.99 10.49v0.14c0 5.68 4.1 10.64 10.13 10.64s9.99-4.74 9.99-10.49z"/>
    <path class="cls-1" d="M310.77,13.94h10.93v7.76c2.23-5.25,5.75-8.77,12.29-8.48v11.43h-.58c-7.26,0-11.71,4.31-11.71,13.58v14.23h-10.93V13.94Z"/>
    <path class="cls-1" d="M340.82,13.94h10.93v7.76c2.23-5.25,5.75-8.77,12.29-8.48v11.43h-.58c-7.26,0-11.71,4.31-11.71,13.58v14.23h-10.93V13.94Z"/>
    <path class="cls-1" d="M371.1,0h11.5v9.7h-11.5V0ZM371.38,13.94h10.93v38.52h-10.93V13.94Z"/>
    <path class="cls-1" d="M389.58,47.36l4.67-7.19c4.24,3.09,8.48,4.6,12.15,4.6,3.16,0,4.6-1.15,4.6-2.88v-.14c0-2.37-3.74-3.09-7.98-4.46-5.39-1.51-11.5-4.1-11.5-11.57v-.14c0-7.84,6.32-12.22,14.09-12.22,4.89,0,10.13,1.65,14.37,4.46l-4.17,7.55c-3.81-2.23-7.62-3.59-10.42-3.59-2.66,0-4.02,1.15-4.02,2.66v.14c0,2.01,3.67,3.31,7.83,4.6,5.39,1.72,11.64,4.38,11.64,11.43v.14c0,8.55-6.4,12.43-14.73,12.43-5.46,0-11.36-1.8-16.53-5.82Z"/>
    </g>
    </svg>
    <div class="repel flex">
        <div class="subtitle">
        Designer, Pretend Photographer, <span>Dad</span>
        </div>
        <div class="follow_links flex">
            <a aria-label="micro.blog" href="https://micro.blog/gregmorris/"><i class="fa-brands fa-microblog"></i></a>
            <a aria-label="bluesky" href="https://bsky.app/profile/gr36.com"><i class="fa-brands fa-bluesky"></i></a>
            <a aria-label="mastodon" href="https://social.lol/@gr36"><i class="fa-brands fa-mastodon"></i></a>
            <a aria-label="buy me a coffee" href="https://www.buymeacoffee.com/gregmorris"><i class="fa-solid fa-mug-saucer"></i></a>
        </div>

    </div>

</div>

<nav>
    <ul>
        <li >
            <a href="/">Home</a>
        </li>
        
        
        <li >
            <a href="/podcast/">Podcast</a>
        </li>
        
        <li >
            <a href="/photos/">Photos</a>
        </li>
        
        <li >
            <a href="/reading/">Reading</a>
        </li>
        
        <li >
            <a href="/about/">About Me</a>
        </li>
        
    </ul>
</nav>



<article data-pagefind-body class="h-entry post">
  <div class="post-title flow">

<div><span>

    <a href="/categories/essay"><i class="fa-solid fa-tag"></i>  Essay </a>

</span></div>


    <h1 class="p-name">My Blog Webmention Counts</h1>
 
<div class="datetime" style="font-size: 70%">
    <i class="fa-regular fa-calendar"></i> 
    <time datetime="2024-02-18 08:22:00 &#43;0000">18 Feb 2024</time>
  </div>
  </div>

  <section class="e-content post-body">
      <hr>
<p>This week I have been building parts of my blog, to learn and to get it to a point that I am happy with. A large part of this was webmentions, and thanks to a few <a href="https://mxb.dev/blog/using-webmentions-on-static-sites/">excellent</a> <a href="https://equk.co.uk/2023/07/18/adding-webmentions-in-eleventy/">guides</a> I got 90% of the the way their. With only a few design things to think through I read <a href="https://campegg.com/2024/02/11/over-the-last.html">more</a> <a href="https://rknight.me/blog/webmentions-redux/">posts</a> on webmentions and realised the way I was doing it was the best solution for privacy and so here we are with a reduced version.</p>
<p>I need to preface this with the fact I am a noob, and this might be a) wrong or b) a stupid way of doing it. This is just the way I did it, and if you’ve got some advice I am all ears.</p>
<h2 id="webmentions">Webmentions</h2>
<p>I had already implemented a script to pull these from webmention.io and cache these into a local file.</p>
<pre tabindex="0"><code>  // Import required modules
  const fetch = require(&#39;node-fetch&#39;);
  const fs = require(&#39;fs&#39;);
  const path = require(&#39;path&#39;);
  require(&#39;dotenv&#39;).config();

  // Constants
  const CACHE_DIR = &#39;./_cache&#39;;
  const API_ORIGIN = &#39;https://webmention.io/api/mentions.jf2&#39;;
  const TOKEN = process.env.WEBMENTION_IO_TOKEN;

  // Ensure cache directory exists
  if (!fs.existsSync(CACHE_DIR)) {
      fs.mkdirSync(CACHE_DIR);
  }

  // Function to fetch data from the API
  async function fetchData() {
      try {
          const response = await fetch(`${API_ORIGIN}?token=${TOKEN}`);
          if (!response.ok) {
              throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
          }
          const data = await response.json();
          return data;
      } catch (error) {
          console.error(&#39;Error fetching data:&#39;, error.message);
          throw error;
      }
  }

  // Function to save data to JSON file
  function saveDataToFile(data) {
      try {
          const filePath = path.join(CACHE_DIR, &#39;webmentions.json&#39;);
          fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
          console.log(&#39;Data saved to:&#39;, filePath);
      } catch (error) {
          console.error(&#39;Error saving data to file:&#39;, error.message);
          throw error;
      }
  }

  // Main function to fetch data and save it to file
  async function main() {
      try {
          const data = await fetchData();
          saveDataToFile(data);
      } catch (error) {
          console.error(&#39;An error occurred:&#39;, error.message);
          process.exit(1);
      }
  }

  // Run main function
  main();
</code></pre><p>Instead of loading all of the information from this as most guides do, I decided instead to simply count the important details. I think this could be cleaner but its working as thats all I am working on at the moment.</p>
<pre tabindex="0"><code>{% raw %}
const filteredWebmentions = data.children.filter(entry =&gt; {
      return entry[&#39;like-of&#39;] === url || entry[&#39;in-reply-to&#39;] === url || entry[&#39;repost-of&#39;] === url;
    });

    // Initialize counts for each type
    let likeCount = 0;
    let replyCount = 0;
    let repostCount = 0;

    // Loop through each entry in the filtered webmentions
    filteredWebmentions.forEach(entry =&gt; {
      // Check if the entry matches the given URL for like, reply, or repost
      if (entry[&#39;like-of&#39;] === url) {
        likeCount++;
      }
      if (entry[&#39;in-reply-to&#39;] === url) {
        replyCount++;
      }
      if (entry[&#39;repost-of&#39;] === url) {
        repostCount++;
      }
    });

    // Return an object containing the counts
    return {
      likeCount,
      replyCount,
      repostCount
    };
{% endraw %}
</code></pre><p>This is then displayed on my post using:</p>
<pre tabindex="0"><code>{% raw %}
{% set urlnohtml = page.url | url | absoluteUrl(metadata.url) | replace(&#39;.html&#39;, &#39;&#39;) %}
{% set urlhtml = page.url | url | absoluteUrl(metadata.url) %}
{% set countnohtml = webmentionsFilePath | countWebmentions(urlnohtml) %}
{% set counthtml = webmentionsFilePath | countWebmentions(urlhtml) %}
{% set totallikes = countnohtml.likeCount + counthtml.likeCount %}
{% set totalreplies = countnohtml.replyCount + counthtml.replyCount %}
{% set totalrepost = countnohtml.repostCount + counthtml.repostCount %}
{% endraw %}
</code></pre><p>This is not very effect as I ran into an issue where i had shared some links with <code>.html</code> on the end and some without, so got an MVP working late last night.</p>
<p><img src="https://greg-morris.micro.blog/uploads/2024/6c7d3fa5a0.jpg" alt=""></p>
<h2 id="mastodon-information">Mastodon Information</h2>
<p>I could then link people to the resulting Mastodon post but decided I wanted to go further and display the information from the toot.</p>
<p>The easy way would have been to rely on the embed code and link to the toot, but I decided instead to make as many things static as possible. Deciding instead to pull the rss feed from my account and filter it by the page url.</p>
<pre tabindex="0"><code>{% raw %}
const axios = require(&#39;axios&#39;);
const Parser = require(&#39;rss-parser&#39;);
const fs = require(&#39;fs&#39;);

const rssFeedUrl = &#39;https://social.lol/@gr36.rss&#39;;
const jsonFilePath = &#39;./_cache/mastodon.json&#39;;

// Function to read the previously saved entries from the JSON file
const readSavedEntries = () =&gt; {
  try {
    const jsonData = fs.readFileSync(jsonFilePath, &#39;utf8&#39;);
    return JSON.parse(jsonData).map(entry =&gt; entry.link);
  } catch (error) {
    // If the file doesn&#39;t exist or is empty, return an empty array
    return [];
  }
};

axios.get(rssFeedUrl)
  .then(response =&gt; {
    const parser = new Parser();
    return parser.parseString(response.data);
  })
  .then(feed =&gt; {
    const savedEntryUrls = readSavedEntries();
    const newEntries = feed.items.filter(item =&gt; !savedEntryUrls.includes(item.link));

    if (newEntries.length === 0) {
      console.log(&#39;No new entries found.&#39;);
      return;
    }

    const items = newEntries.map(item =&gt; ({
      link: item.link,
      pubDate: item.pubDate,
      content: item.content
    }));

    const jsonData = JSON.stringify([...items, ...readSavedEntries()], null, 2);

    fs.writeFile(jsonFilePath, jsonData, err =&gt; {
      if (err) {
        console.error(&#39;Error writing JSON file:&#39;, err);
        return;
      }
      console.log(`${newEntries.length} new entries saved to ${jsonFilePath}`);
    });
  })
  .catch(error =&gt; {
    console.error(&#39;Error fetching or parsing RSS feed:&#39;, error);
  });
{% endraw %}
</code></pre><p>This is then parsed into json (I just think it looks better) and stored in a cache file.</p>
<p>I can then query this for specific page urls using</p>
<pre tabindex="0"><code>{% raw %}
eleventyConfig.addFilter(&#39;searchContentForUrl&#39;, (mastodonData, currentPageUrl) =&gt; {
  // Load the JSON data
  const jsonData = JSON.parse(fs.readFileSync(&#39;./_cache/mastodon.json&#39;, &#39;utf8&#39;));
  
  // Iterate over entries and search for the current URL in content property
  for (const entry of jsonData) {
    if (entry.content.includes(currentPageUrl)) {
      return entry;
    }
  }
  
  return null; // Return null if URL is not found in any content property
});
{% endraw %}
</code></pre><p>And display thing on the post page using <code>{% raw %}{% set mastoContent = mastodon | searchContentForUrl(urlnohtml) %}{% endraw %}</code></p>
<p>I then show this with:</p>
<pre tabindex="0"><code>{% raw %}
&lt;a href=&#34;{{ mastoContent.link}}&#34;&gt;&lt;i class=&#34;fa-brands fa-mastodon&#34;&gt;&lt;/i&gt; Join the conversation on Mastodon
&lt;div&gt;{{ mastoContent.content | safe }}&lt;/div&gt;&lt;/a&gt;
{% endraw %}
</code></pre><h2 id="future-plans">Future Plans</h2>
<p>Like I said right at the start, I am a complete noob with front end and I am currently studying to improve things. I’d like to pull all the information once using the mastodon API, so I have access to replies_count, reblogs_count and favourites_count but that can wait for now.</p>
<p>This only shows on a few posts due to a change in URL but I am planning to pull in old data and show this too. All in all, I’m fairly happy with it for now considering it was cobbled together fairly quickly when I changed my mind on what I wanted to display. Any helpful recommendation will be happily received.</p>

  </section>



</article>
<div class="post-meta">
   <div><span>Reply via</span></div>
<div class="sydication">

    <div class="microblog">
      <a class="u-syndication conversation-my-blog-webmention-counts" href="https://micro.blog/gregmorris/"><i class="fa-brands fa-microblog"></i> Micro.blog</a>
    </div>


  

  

  

<div class="email">
  








  



  <a class="reply-by-email" href="/reply-by-email/" data-meta="46736254466c76526e706a667e176e487e5d71146963405d695e7d517d161d506e706a634717724d4549724e4067715e76626e486e706a666e706d53707c4f48694e666746631d4a6e706d537216724d4673725140634852464d715d69616a524073111447531919"><i class="fa-solid fa-envelope"></i> Email</a>


</div>
</div>
<a class="support" href="https://www.buymeacoffee.com/gregmorris">
 Found this post usefull? Consider buying me a cofee
    <i class="fa-solid fa-turn-up" aria-hidden="true"></i><i class="fa-solid fa-mug-hot" aria-hidden="true"></i>
</a>
</div>
<div class="comments">
  
  <details id="leave-reply">
    <summary>Leave A Reply Instead? <i class="fa-brands fa-microblog"></i><i class="fa-brands fa-bluesky" ></i><i class="fa-brands fa-mastodon"></i></summary>
  </details>

  
  <details id="comments-section">
    <summary id="comments-summary">Read Comments (0)</summary>
    <div id="microblog-comments"></div>
  </details>

  
  <script type="text/javascript" src="https://micro.blog/conversation.js?url=http%3a%2f%2flocalhost%3a1313%2f2024%2f02%2f18%2fmy-blog-webmention.html"></script>
</div>

<script>
  
  document.addEventListener("DOMContentLoaded", function () {
    const conversationContainer = document.querySelector(".microblog_conversation");

    if (conversationContainer) {
      
      const comments = conversationContainer.querySelectorAll(".microblog_post");
      const replyForm = conversationContainer.querySelector(".microblog_reply_form");

      
      const replyDetails = document.getElementById("leave-reply");
      if (replyForm) replyDetails.appendChild(replyForm);

      
      const commentsDiv = document.getElementById("microblog-comments");
      const commentsSection = document.getElementById("comments-section");
      const commentsSummary = document.getElementById("comments-summary");
      let commentCount = 0;

      comments.forEach((comment) => {
        commentsDiv.appendChild(comment);
        commentCount++;
      });

      
      commentsSummary.textContent = `Read Comments (${commentCount})`;

      
      if (commentCount === 0) {
        commentsSection.style.display = "none";
      }

      
      conversationContainer.remove();
    }
  });
</script>



<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CESI5KJI&placement=gregmorriscouk&format=cover" id="_carbonads_js"></script>



<section id="footer">
  Subscribe | 
  <a href="/feed.xml">RSS</a> | 
<a href="/feed.json">JSON</a> | 
  <a href="https://www.buymeacoffee.com/gregmorris">Support me</a>
  <div>❤️ made with love by me</div>
</section>



</body>
</html>
